# Template file for 'nvidia-container-runtime'
pkgname=nvidia-container-runtime
version=3.1.4
revision=1
hostmakedepends="curl go git"
makedepends="libseccomp-devel"
depends="containerd runc libnvidia-container"
short_desc="Modified version of runc adding a custom pre-start hook"
maintainer="Soroush Haeri <soroosh.haeri@me.com>"
license="BSD-3-Clause"
homepage="https://github.com/NVIDIA/nvidia-container-runtime/"
distfiles="https://github.com/NVIDIA/nvidia-container-runtime/archive/v${version}.tar.gz"
checksum="32bd9f49a1392253dccbfebc850b980b6d7cbd1b2621b06ced4fbe952c918038"

pre_build() {
	go get github.com/BurntSushi/toml
	mkdir -p .gopath/src
	ln -rTsf $PWD/runtime/src .gopath/src/${pkgname}
	ln -rTsf $PWD/toolkit/nvidia-container-toolkit  .gopath/src/nvidia-container-toolkit
	export GOPATH=$PWD/.gopath/
}

do_build() {
	# Build the container runtime
	go build \
	  -buildmode=pie \
	  -gcflags "all=-trimpath=${PWD}" \
	  -asmflags "all=-trimpath=${PWD}" \
	  "$pkgname"
	# Build the container toolkit
	go build \
	  -buildmode=pie \
	  -gcflags "all=-trimpath=${PWD}" \
	  -asmflags "all=-trimpath=${PWD}" \
	  nvidia-container-toolkit
}

do_install() {
	vbin nvidia-container-runtime
	vbin nvidia-container-toolkit
}

post_install() {
	# Docker requires a nvidia-container-runtime-hook
	echo [nvidia-container-runtime] > config.toml
	echo debug = \"/var/log/nvidia-container-runtime\" >> config.toml
	vmkdir /etc/nvidia-container-runtime 755
	vinstall config.toml 755 /etc/nvidia-container-runtime
	vlicense LICENSE
}
